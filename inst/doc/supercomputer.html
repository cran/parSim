<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Mihai Constantin and Sacha Epskamp" />


<title>Using parSim on a supercomputer</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Using <code>parSim</code> on a
supercomputer</h1>
<h4 class="author">Mihai Constantin and Sacha Epskamp</h4>
<h4 class="date">October 26th, 2024</h4>



<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>In this short vignette we illustrate the main steps for using the
<code>parSim</code> package to execute a simulation on a supercomputer.
We use as example the job scheduler employed by the Dutch <a href="https://www.surf.nl/en/lisa-computing-cluster-extra-computing-power-for-research">Lisa
Computing Cluster</a>, however the steps are similar for other
supercomputers.</p>
</div>
<div id="writing-the-simulation-script" class="section level2">
<h2>Writing the Simulation Script</h2>
<p>The first step is to write a simulation script compatible with the
<code>parSim</code> package. Suppose we have have the following
simulation conditions:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="co"># Sample size.</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>sample_size <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">100</span>, <span class="dv">250</span>)</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="co"># Beta values.</span></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a>beta <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>)</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a><span class="co"># Sigma values.</span></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a>sigma <span class="ot">=</span> <span class="fu">c</span>(<span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="dv">1</span>)</span></code></pre></div>
<p>Then, our simulation script could look like the following, where we
are interested in computing the bias:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="co"># The function to evaluate for each simulation condition.</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>bias <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y) {</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>    <span class="co"># Perform some computation.</span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>    result <span class="ot">&lt;-</span> <span class="fu">abs</span>(x <span class="sc">-</span> y)</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a>    <span class="co"># Return the result.</span></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a>    <span class="fu">return</span>(result)</span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a>}</span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a><span class="co"># The simulation expression to evaluate for each simulation condition.</span></span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a>{</span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a>    <span class="co"># Generate the data.</span></span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(sample_size)</span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a>    y <span class="ot">&lt;-</span> beta <span class="sc">*</span> x <span class="sc">+</span> <span class="fu">rnorm</span>(sample_size, sigma)</span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" tabindex="-1"></a>    <span class="co"># Fit the model.</span></span>
<span id="cb2-17"><a href="#cb2-17" tabindex="-1"></a>    fit <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> x)</span>
<span id="cb2-18"><a href="#cb2-18" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" tabindex="-1"></a>    <span class="co"># Compute the relevant quantities.</span></span>
<span id="cb2-20"><a href="#cb2-20" tabindex="-1"></a>    beta_estimate <span class="ot">&lt;-</span> <span class="fu">coef</span>(fit)[<span class="dv">2</span>]</span>
<span id="cb2-21"><a href="#cb2-21" tabindex="-1"></a>    r_squared <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit)<span class="sc">$</span>r.squared</span>
<span id="cb2-22"><a href="#cb2-22" tabindex="-1"></a>    bias <span class="ot">&lt;-</span> <span class="fu">bias</span>(beta, beta_estimate)</span>
<span id="cb2-23"><a href="#cb2-23" tabindex="-1"></a></span>
<span id="cb2-24"><a href="#cb2-24" tabindex="-1"></a>    <span class="co"># Return in a compatible format.</span></span>
<span id="cb2-25"><a href="#cb2-25" tabindex="-1"></a>    <span class="fu">list</span>(</span>
<span id="cb2-26"><a href="#cb2-26" tabindex="-1"></a>        <span class="at">beta_estimate =</span> beta_estimate,</span>
<span id="cb2-27"><a href="#cb2-27" tabindex="-1"></a>        <span class="at">r_squared =</span> r_squared,</span>
<span id="cb2-28"><a href="#cb2-28" tabindex="-1"></a>        <span class="at">bias =</span> bias</span>
<span id="cb2-29"><a href="#cb2-29" tabindex="-1"></a>    )</span>
<span id="cb2-30"><a href="#cb2-30" tabindex="-1"></a>}</span></code></pre></div>
<p>If we put these pieces of code together, then our <code>parSim</code>
simulation function looks like the following:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="co"># Run the simulation.</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">parSim</span>(</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>    <span class="co"># The simulation conditions.</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>    <span class="at">sample_size =</span> <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">100</span>, <span class="dv">250</span>),</span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>    <span class="at">beta =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>),</span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a>    <span class="at">sigma =</span> <span class="fu">c</span>(<span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="dv">1</span>),</span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a>    <span class="co"># The expression to evaluate for each simulation condition.</span></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a>    <span class="at">expression =</span> {</span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a>        <span class="co"># Generate the data.</span></span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a>        x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(sample_size)</span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a>        y <span class="ot">&lt;-</span> beta <span class="sc">*</span> x <span class="sc">+</span> <span class="fu">rnorm</span>(sample_size, sigma)</span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" tabindex="-1"></a>        <span class="co"># Fit the model.</span></span>
<span id="cb3-15"><a href="#cb3-15" tabindex="-1"></a>        fit <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> x)</span>
<span id="cb3-16"><a href="#cb3-16" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" tabindex="-1"></a>        <span class="co"># Compute the relevant quantities.</span></span>
<span id="cb3-18"><a href="#cb3-18" tabindex="-1"></a>        beta_estimate <span class="ot">&lt;-</span> <span class="fu">coef</span>(fit)[<span class="dv">2</span>]</span>
<span id="cb3-19"><a href="#cb3-19" tabindex="-1"></a>        r_squared <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit)<span class="sc">$</span>r.squared</span>
<span id="cb3-20"><a href="#cb3-20" tabindex="-1"></a>        bias <span class="ot">&lt;-</span> <span class="fu">bias</span>(beta, beta_estimate)</span>
<span id="cb3-21"><a href="#cb3-21" tabindex="-1"></a></span>
<span id="cb3-22"><a href="#cb3-22" tabindex="-1"></a>        <span class="co"># Return in a compatible format.</span></span>
<span id="cb3-23"><a href="#cb3-23" tabindex="-1"></a>        <span class="fu">list</span>(</span>
<span id="cb3-24"><a href="#cb3-24" tabindex="-1"></a>            <span class="at">beta_estimate =</span> beta_estimate,</span>
<span id="cb3-25"><a href="#cb3-25" tabindex="-1"></a>            <span class="at">r_squared =</span> r_squared,</span>
<span id="cb3-26"><a href="#cb3-26" tabindex="-1"></a>            <span class="at">bias =</span> bias</span>
<span id="cb3-27"><a href="#cb3-27" tabindex="-1"></a>        )</span>
<span id="cb3-28"><a href="#cb3-28" tabindex="-1"></a>    },</span>
<span id="cb3-29"><a href="#cb3-29" tabindex="-1"></a></span>
<span id="cb3-30"><a href="#cb3-30" tabindex="-1"></a>    <span class="co"># The variables to export.</span></span>
<span id="cb3-31"><a href="#cb3-31" tabindex="-1"></a>    <span class="at">exports =</span> <span class="fu">c</span>(<span class="st">&quot;bias&quot;</span>)</span>
<span id="cb3-32"><a href="#cb3-32" tabindex="-1"></a>)</span></code></pre></div>
<p>There are a few adjustments to make to the <code>parSim</code>
function call above before we are ready to place it in an <code>R</code>
script file and deploy it on a supercomputer. At a bare minimum, we need
to:</p>
<ul>
<li>Decide on the number of <code>replications</code> to run for each
simulation condition, e.g., <code>replications = 1000</code>.</li>
<li>Export any external objects (i.e., via the <code>exports</code>
argument) or <code>R</code> packages (i.e., via the
<code>packages</code> argument) that are needed for the simulation
script to run. In the example above, we need to export the
<code>bias</code> function, so we would set
<code>exports = c(&quot;bias&quot;)</code>, and no additional packages are
required.</li>
<li>Decide on the number of <code>cores</code> to use for the
simulation. The Lisa Compute Cluster has <code>16</code> cores per node,
so we could set <code>cores = 15</code>. Note that the parallel backend
<a href="https://parabar.mihaiconstantin.com"><code>parabar</code></a>
used by <code>parSim</code> will ensure that at lease one core is
available for the main process.</li>
<li>Finally, we need to save the results of each <code>parSim</code>
function execution to a file. Considering the intricacies of
supercomputers, it is best to specify the file name and path ourselves.
To do so, we can pass the file name as a string to the <code>save</code>
argument and ensure that the file name is unique for each
<code>parSim</code> function execution (e.g., by appending the job or
task ID).</li>
</ul>
<p><em>Note.</em> Check out the documentation for <code>parSim</code>
for more information on the function arguments (e.g., on how to exclude
certain simulation conditions via the <code>exclude</code>
argument).</p>
<p>With the considerations above in mind, we can now write our
<code>simulation.R</code> file as follows:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="co">#!/usr/bin/env Rscript</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="co"># Clear the environment to ensure a fresh start.</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>(<span class="at">all.names =</span> <span class="cn">TRUE</span>))</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a><span class="co"># Get the temporary directory from the environment.</span></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>TMP_DIR <span class="ot">&lt;-</span> <span class="fu">Sys.getenv</span>(<span class="st">&quot;TMP_DIR&quot;</span>)</span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a><span class="co"># Create the output path.</span></span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a>out_dir <span class="ot">&lt;-</span> <span class="fu">paste0</span>(TMP_DIR, <span class="st">&quot;/output&quot;</span>)</span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a><span class="co"># Load the current job ID in the batch array.</span></span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a>job_id <span class="ot">&lt;-</span> <span class="fu">Sys.getenv</span>(<span class="st">&quot;SLURM_ARRAY_TASK_ID&quot;</span>)</span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a><span class="co"># Prepare a unique file name for the results.</span></span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a>file_name <span class="ot">&lt;-</span> <span class="fu">paste0</span>(out_dir, <span class="st">&quot;/simulation_results_id_&quot;</span>, job_id)</span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" tabindex="-1"></a><span class="co"># Load libraries.</span></span>
<span id="cb4-19"><a href="#cb4-19" tabindex="-1"></a><span class="fu">library</span>(parSim)</span>
<span id="cb4-20"><a href="#cb4-20" tabindex="-1"></a><span class="fu">library</span>(flexiblas)</span>
<span id="cb4-21"><a href="#cb4-21" tabindex="-1"></a></span>
<span id="cb4-22"><a href="#cb4-22" tabindex="-1"></a><span class="co"># For `R` complied with the `foss` (i.e., `flexiblas`) toolchain, we set the</span></span>
<span id="cb4-23"><a href="#cb4-23" tabindex="-1"></a><span class="co"># number of threads to one.</span></span>
<span id="cb4-24"><a href="#cb4-24" tabindex="-1"></a>flexiblas<span class="sc">::</span><span class="fu">flexiblas_set_num_threads</span>(<span class="dv">1</span>)</span>
<span id="cb4-25"><a href="#cb4-25" tabindex="-1"></a></span>
<span id="cb4-26"><a href="#cb4-26" tabindex="-1"></a><span class="co"># Run the simulation.</span></span>
<span id="cb4-27"><a href="#cb4-27" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">parSim</span>(</span>
<span id="cb4-28"><a href="#cb4-28" tabindex="-1"></a>    <span class="co"># The simulation conditions.</span></span>
<span id="cb4-29"><a href="#cb4-29" tabindex="-1"></a>    <span class="at">sample_size =</span> <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">100</span>, <span class="dv">250</span>),</span>
<span id="cb4-30"><a href="#cb4-30" tabindex="-1"></a>    <span class="at">beta =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>),</span>
<span id="cb4-31"><a href="#cb4-31" tabindex="-1"></a>    <span class="at">sigma =</span> <span class="fu">c</span>(<span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="dv">1</span>),</span>
<span id="cb4-32"><a href="#cb4-32" tabindex="-1"></a></span>
<span id="cb4-33"><a href="#cb4-33" tabindex="-1"></a>    <span class="co"># The expression to evaluate for each simulation condition.</span></span>
<span id="cb4-34"><a href="#cb4-34" tabindex="-1"></a>    <span class="at">expression =</span> {</span>
<span id="cb4-35"><a href="#cb4-35" tabindex="-1"></a>        <span class="co"># Generate the data.</span></span>
<span id="cb4-36"><a href="#cb4-36" tabindex="-1"></a>        x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(sample_size)</span>
<span id="cb4-37"><a href="#cb4-37" tabindex="-1"></a>        y <span class="ot">&lt;-</span> beta <span class="sc">*</span> x <span class="sc">+</span> <span class="fu">rnorm</span>(sample_size, sigma)</span>
<span id="cb4-38"><a href="#cb4-38" tabindex="-1"></a></span>
<span id="cb4-39"><a href="#cb4-39" tabindex="-1"></a>        <span class="co"># Fit the model.</span></span>
<span id="cb4-40"><a href="#cb4-40" tabindex="-1"></a>        fit <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> x)</span>
<span id="cb4-41"><a href="#cb4-41" tabindex="-1"></a></span>
<span id="cb4-42"><a href="#cb4-42" tabindex="-1"></a>        <span class="co"># Compute the relevant quantities.</span></span>
<span id="cb4-43"><a href="#cb4-43" tabindex="-1"></a>        beta_estimate <span class="ot">&lt;-</span> <span class="fu">coef</span>(fit)[<span class="dv">2</span>]</span>
<span id="cb4-44"><a href="#cb4-44" tabindex="-1"></a>        r_squared <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit)<span class="sc">$</span>r.squared</span>
<span id="cb4-45"><a href="#cb4-45" tabindex="-1"></a>        bias <span class="ot">&lt;-</span> <span class="fu">bias</span>(beta, beta_estimate)</span>
<span id="cb4-46"><a href="#cb4-46" tabindex="-1"></a></span>
<span id="cb4-47"><a href="#cb4-47" tabindex="-1"></a>        <span class="co"># Return in a compatible format.</span></span>
<span id="cb4-48"><a href="#cb4-48" tabindex="-1"></a>        <span class="fu">list</span>(</span>
<span id="cb4-49"><a href="#cb4-49" tabindex="-1"></a>            <span class="at">beta_estimate =</span> beta_estimate,</span>
<span id="cb4-50"><a href="#cb4-50" tabindex="-1"></a>            <span class="at">r_squared =</span> r_squared,</span>
<span id="cb4-51"><a href="#cb4-51" tabindex="-1"></a>            <span class="at">bias =</span> bias</span>
<span id="cb4-52"><a href="#cb4-52" tabindex="-1"></a>        )</span>
<span id="cb4-53"><a href="#cb4-53" tabindex="-1"></a>    },</span>
<span id="cb4-54"><a href="#cb4-54" tabindex="-1"></a></span>
<span id="cb4-55"><a href="#cb4-55" tabindex="-1"></a>    <span class="co"># The variables to export.</span></span>
<span id="cb4-56"><a href="#cb4-56" tabindex="-1"></a>    <span class="at">exports =</span> <span class="fu">c</span>(<span class="st">&quot;bias&quot;</span>),</span>
<span id="cb4-57"><a href="#cb4-57" tabindex="-1"></a></span>
<span id="cb4-58"><a href="#cb4-58" tabindex="-1"></a>    <span class="co"># The number of replications.</span></span>
<span id="cb4-59"><a href="#cb4-59" tabindex="-1"></a>    <span class="at">replications =</span> <span class="dv">1000</span>,</span>
<span id="cb4-60"><a href="#cb4-60" tabindex="-1"></a></span>
<span id="cb4-61"><a href="#cb4-61" tabindex="-1"></a>    <span class="co"># The variables to export.</span></span>
<span id="cb4-62"><a href="#cb4-62" tabindex="-1"></a>    <span class="at">exports =</span> <span class="fu">c</span>(<span class="st">&quot;bias&quot;</span>),</span>
<span id="cb4-63"><a href="#cb4-63" tabindex="-1"></a></span>
<span id="cb4-64"><a href="#cb4-64" tabindex="-1"></a>    <span class="co"># Save the results.</span></span>
<span id="cb4-65"><a href="#cb4-65" tabindex="-1"></a>    <span class="at">save =</span> file_name,</span>
<span id="cb4-66"><a href="#cb4-66" tabindex="-1"></a></span>
<span id="cb4-67"><a href="#cb4-67" tabindex="-1"></a>    <span class="co"># Execute the simulation on a single core.</span></span>
<span id="cb4-68"><a href="#cb4-68" tabindex="-1"></a>    <span class="at">cores =</span> <span class="dv">16</span></span>
<span id="cb4-69"><a href="#cb4-69" tabindex="-1"></a>)</span></code></pre></div>
<p>It is always a good idea to test the <code>simulation.R</code> script
locally before deploying it on a supercomputer (i.e., debugging could be
much easier on your local machine).</p>
</div>
<div id="preparing-the-job-script" class="section level2">
<h2>Preparing the Job Script</h2>
<p>The next step consist in preparing the job script that will be used
to submit the <code>simulation.R</code> script to the supercomputer. The
job script is a shell script that specifies the resources needed for the
job. For more information on the specifics of the job script, please
refer to the documentation of the supercomputer you are using.</p>
<p>Let’s assume we are using the Lisa Compute Cluster and our
<code>simulation.R</code> script is located in the
<code>~/simulation-example</code> directory on the <code>login</code>
node. Then, our job script could look like the following:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="co">#SBATCH -N 1</span></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a><span class="co">#SBATCH -p normal</span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a><span class="co">#SBATCH -t 01:00:00</span></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a><span class="co"># Load modules.</span></span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a><span class="ex">module</span> load 2021</span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a><span class="ex">module</span> load R/4.1.0-foss-2021a</span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a><span class="co"># Set the user.</span></span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a><span class="bu">export</span> <span class="va">USERNAME</span><span class="op">=</span>mihaiconstantin</span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a><span class="co"># Define the simulation path on the login node.</span></span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a><span class="bu">export</span> <span class="va">SIM_DIR</span><span class="op">=</span><span class="va">$HOME</span>/simulation-example</span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a></span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a><span class="co"># Export packages on the login node.</span></span>
<span id="cb5-17"><a href="#cb5-17" tabindex="-1"></a><span class="bu">export</span> <span class="va">R_LIBS</span><span class="op">=</span><span class="va">$HOME</span>/R/x86_64-pc-linux-gnu-library/4.1</span>
<span id="cb5-18"><a href="#cb5-18" tabindex="-1"></a></span>
<span id="cb5-19"><a href="#cb5-19" tabindex="-1"></a><span class="co"># Define temporary directory.</span></span>
<span id="cb5-20"><a href="#cb5-20" tabindex="-1"></a><span class="bu">export</span> <span class="va">TMP_DIR</span><span class="op">=</span><span class="va">$TMPDIR</span>/<span class="va">$USERNAME</span></span>
<span id="cb5-21"><a href="#cb5-21" tabindex="-1"></a></span>
<span id="cb5-22"><a href="#cb5-22" tabindex="-1"></a><span class="co"># Make output directory.</span></span>
<span id="cb5-23"><a href="#cb5-23" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> <span class="va">$TMP_DIR</span>/output</span>
<span id="cb5-24"><a href="#cb5-24" tabindex="-1"></a></span>
<span id="cb5-25"><a href="#cb5-25" tabindex="-1"></a><span class="co"># Run the script (i.e., using 15 cores).</span></span>
<span id="cb5-26"><a href="#cb5-26" tabindex="-1"></a><span class="co"># Note. The script sets the number of threads to 1.</span></span>
<span id="cb5-27"><a href="#cb5-27" tabindex="-1"></a><span class="ex">Rscript</span> <span class="va">$SIM_DIR</span>/simulation.R</span>
<span id="cb5-28"><a href="#cb5-28" tabindex="-1"></a></span>
<span id="cb5-29"><a href="#cb5-29" tabindex="-1"></a><span class="co"># Copy output from scratch.</span></span>
<span id="cb5-30"><a href="#cb5-30" tabindex="-1"></a><span class="fu">cp</span> <span class="at">-r</span> <span class="va">$TMP_DIR</span>/output/. <span class="va">$SIM_DIR</span>/output</span>
<span id="cb5-31"><a href="#cb5-31" tabindex="-1"></a></span>
<span id="cb5-32"><a href="#cb5-32" tabindex="-1"></a><span class="co"># Exit message.</span></span>
<span id="cb5-33"><a href="#cb5-33" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Job </span><span class="va">$SLURM_ARRAY_JOB_ID</span><span class="st"> (</span><span class="va">$SLURM_ARRAY_TASK_ID</span><span class="st"> / </span><span class="va">$SLURM_ARRAY_TASK_COUNT</span><span class="st">) honored.&quot;</span></span></code></pre></div>
<p>Please make sure to adjust the job script above to:</p>
<ul>
<li>Load the correct version of <code>R</code>.</li>
<li>Set the correct paths for the <code>SIM_DIR</code> and
<code>TMP_DIR</code> variables.</li>
<li>Replace <code>mihaiconstantin</code> with your username for the
<code>USERNAME</code> variable.</li>
<li>Adjust the <code>#SBATCH</code> directives to match the resources
needed for your job. This part is crucial if you want to avoid having
your job killed by the scheduler. For instance, the
<code>#SBATCH -t 01:00:00</code> directive refers to the <em>wall
time</em> and specifies that the job will run for one hour. This value
should be adjusted according to the expected execution duration of the
<code>parSim</code> function specified in the <code>simulation.R</code>
script.</li>
</ul>
</div>
<div id="submitting-the-job" class="section level2">
<h2>Submitting the Job</h2>
<p>At this point, we are ready to submit the job to the supercomputer.
To do so, we can dispatch an array of jobs using the <code>sbatch</code>
command. For instance, to submit the job script above <code>100</code>
times to the Lisa Compute Cluster, we can use the following command:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="ex">sbatch</span> <span class="at">--array</span><span class="op">=</span>1-100 job.sh</span></code></pre></div>
<p>This will result in replicating the <code>simulation.R</code> script
<code>100</code> times, each time with a different task ID. The results
of each replication will be saved in a unique file in the
<code>$SIM_DIR/output</code> directory. In total, each simulation
condition will be replicated <code>1000 * 100 = 100000</code> times.</p>
<p>Assuming the username <code>mihaiconstantin</code>, we can monitor
the job queue using the following command:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="ex">squeue</span> <span class="at">-u</span> mihaiconstantin</span></code></pre></div>
<p>Finally, we can cancel a job (i.e., or task in an job array) using
the <code>scancel</code> command as follows:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="ex">scancel</span> job_id</span></code></pre></div>
<p>If <code>job_id</code> is an array of tasks (i.e.,
<code>job_id_1</code>, <code>job_id_2</code>, etc.), then
<code>scancel job_id</code> will cancel all tasks.</p>
</div>
<div id="folder-structure" class="section level2">
<h2>Folder Structure</h2>
<p>Following the example above, our <code>~/simulation-example</code>
directory on the Lisa Compute Cluster should have the following
structure:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode txt"><code class="sourceCode default"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>~/simulation-example/</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>├── job.sh</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>├── simulation.R</span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>└── output/</span></code></pre></div>
</div>
<div id="downloading-the-results" class="section level2">
<h2>Downloading the Results</h2>
<p>Once the job is completed, we can download the results from the
supercomputer to our local machine using the <code>scp</code> command.
For instance, to download the results from the Lisa Compute Cluster, we
can use the following command:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="co"># Navigate on your local machine to a directory of your choice.</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="bu">cd</span> ~/Downloads/simulation-results/</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a><span class="co"># Make a directory where to download the results from the supercomputer.</span></span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a><span class="fu">mkdir</span> output</span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a><span class="co"># Download the results.</span></span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a><span class="fu">scp</span> mihaiconstantin@lisa.surfsara.nl:~/simulation-example/output/simulation_results<span class="pp">*</span> ./output/</span></code></pre></div>
<p><em>Note.</em> Make sure to replace <code>mihaiconstantin</code> with
your username and adjust the paths accordingly.</p>
</div>
<div id="processing-the-results" class="section level2">
<h2>Processing the Results</h2>
<p>Finally, we can process the results on our local machine. Suppose we
have a script called <code>analysis.R</code> that contains the following
code:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="co"># Load relevant libraries.</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a><span class="co"># Set the working directory.</span></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">&quot;~/Downloads/simulation-results/&quot;</span>)</span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a><span class="co"># All simulation result files.</span></span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">&quot;output/&quot;</span>, <span class="at">pattern =</span> <span class="st">&quot;simulation_results_&quot;</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a><span class="co"># Read all files and bind them together.</span></span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">do.call</span>(</span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a>    rbind, <span class="fu">lapply</span>(files, read.table, <span class="at">header =</span> <span class="cn">TRUE</span>)</span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a>)</span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a></span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a><span class="co"># Pre-process the results in long format for plotting.</span></span>
<span id="cb11-17"><a href="#cb11-17" tabindex="-1"></a>results_long <span class="ot">&lt;-</span> tidyr<span class="sc">::</span><span class="fu">gather</span>(results, metric, value, beta_estimate<span class="sc">:</span>bias)</span>
<span id="cb11-18"><a href="#cb11-18" tabindex="-1"></a></span>
<span id="cb11-19"><a href="#cb11-19" tabindex="-1"></a><span class="co"># Make factors with nice labels for plotting.</span></span>
<span id="cb11-20"><a href="#cb11-20" tabindex="-1"></a>results_long<span class="sc">$</span>sigma_factor <span class="ot">&lt;-</span> <span class="fu">factor</span>(</span>
<span id="cb11-21"><a href="#cb11-21" tabindex="-1"></a>    <span class="at">x =</span> results_long<span class="sc">$</span>sigma,</span>
<span id="cb11-22"><a href="#cb11-22" tabindex="-1"></a>    <span class="at">levels =</span> <span class="fu">c</span>(<span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="dv">1</span>),</span>
<span id="cb11-23"><a href="#cb11-23" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Sigma: 0.025&quot;</span>, <span class="st">&quot;Sigma: 0.5&quot;</span>, <span class="st">&quot;Sigma: 1&quot;</span>)</span>
<span id="cb11-24"><a href="#cb11-24" tabindex="-1"></a>)</span>
<span id="cb11-25"><a href="#cb11-25" tabindex="-1"></a></span>
<span id="cb11-26"><a href="#cb11-26" tabindex="-1"></a><span class="co"># Plot.</span></span>
<span id="cb11-27"><a href="#cb11-27" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(</span>
<span id="cb11-28"><a href="#cb11-28" tabindex="-1"></a>    results_long, ggplot2<span class="sc">::</span><span class="fu">aes</span>(</span>
<span id="cb11-29"><a href="#cb11-29" tabindex="-1"></a>        <span class="at">x =</span> <span class="fu">factor</span>(sample_size), <span class="at">y =</span> value, <span class="at">fill =</span> <span class="fu">factor</span>(beta))</span>
<span id="cb11-30"><a href="#cb11-30" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb11-31"><a href="#cb11-31" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_grid</span>(</span>
<span id="cb11-32"><a href="#cb11-32" tabindex="-1"></a>        metric <span class="sc">~</span> sigma_factor, <span class="at">scales =</span> <span class="st">&quot;free&quot;</span></span>
<span id="cb11-33"><a href="#cb11-33" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb11-34"><a href="#cb11-34" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb11-35"><a href="#cb11-35" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb11-36"><a href="#cb11-36" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">xlab</span>(<span class="st">&quot;Sample size&quot;</span>) <span class="sc">+</span></span>
<span id="cb11-37"><a href="#cb11-37" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ylab</span>(<span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb11-38"><a href="#cb11-38" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_fill_discrete</span>(<span class="st">&quot;Beta&quot;</span>)</span></code></pre></div>
<p>We hope this helps you get started with running simulations on a
supercomputer using the <code>parSim</code> package. Good luck with your
simulations!</p>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
